<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MCQ Study App Ultra-Pro 4.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.json?v=4.1.0">
  <link rel="stylesheet" href="style.css?v=4.1.0">
</head>
<body>
<div class="app" id="appRoot">
  <header class="top-bar">
    <div>
      <h1>MCQ Study App Ultra‚ÄëPro <span class="ver">v4.2</span></h1>
      <div class="subtitle">Local bank + spaced repetition + weak‚Äëspot engine + dashboard + flashcards + exam sim</div>
    </div>
    <div class="chips">
      <span class="chip">Offline</span>
      <span class="chip chip-ok">Tracks wrong / weak</span>
      <span class="chip chip-flag">Flags & tags</span>
      <span class="chip chip-sync" id="syncStatus">No cloud sync</span>
      <button id="btnBackupQuick" class="chip chip-theme">Backup ‚Üí GitHub</button>
      <select id="themeSelect" class="chip chip-theme">
        <option value="light">‚òÄÔ∏é Light</option>
        <option value="dark">üåô Dark</option>
        <option value="night">üñ§ Night</option>
        <option value="calm">üåø Calm</option>
      </select>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab-button active" data-tab="home">Practice</button>
    <button class="tab-button" data-tab="flashcards">Flashcards</button>
    <button class="tab-button" data-tab="exam">Exam Sim</button>
    <button class="tab-button" data-tab="dashboard">Dashboard</button>
    <button class="tab-button" data-tab="all">All Questions</button>
    <button class="tab-button" data-tab="backup">Backup & Cloud</button>
    <button class="tab-button" data-tab="settings">Settings</button>
  </nav>

  <main class="tab-container">

    <!-- PRACTICE TAB -->
    <section class="tab-content active" id="tab-home">
      <div class="card">
        <div class="stats-row" id="statsBar"></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col-main">
            <div class="row-controls">
              <div>
                <label class="small-label">Practice mode</label><br>
                <select id="modeSelect">
                  <option value="due">Spaced (due now)</option>
                  <option value="all">All active</option>
                  <option value="new">New (never answered)</option>
                  <option value="wrong">Previously wrong</option>
                  <option value="flagged">Flagged</option>
                  <option value="weak">Smart weakness focus</option>
                  <option value="chapter">By chapter</option>
                </select>
                <select id="chapterSelect" style="display:none; max-width:220px;"></select>
                <input id="chapterFilter" placeholder="Chapter (e.g. Ch45 Burns)" style="display:none; max-width:200px;"><br>
                <label class="small-label" style="margin-top:4px; display:inline-block;">
                  <input type="checkbox" id="prefSkipSolved" checked>
                  Prefer unsolved questions (skip solved when possible)
                </label>
              </div>
              <div>
                <label class="small-label">Quick actions</label><br>
                <button class="pill-btn" id="btnQuickWrong">Last wrong</button>
                <button class="pill-btn" id="btnQuickFlagged">Flagged</button>
                <button class="pill-btn" id="btnStartDaily">Daily 10</button>
              </div>
              <div>
                <label class="small-label">Concept‚Äëlink</label><br>
                <div id="relatedBox" class="related-box tiny muted">No related questions yet.</div>
              </div>
            </div>

            <div id="questionPanel" class="question-panel"></div>
            <div id="feedbackPanel" class="feedback-panel"></div>

            <div class="btn-row-main">
              <button class="primary" id="btnSubmit">Submit</button>
              <button id="btnPrev">Previous</button>
              <button id="btnNext">Next</button>
              <button class="ghost" id="btnFlag">Flag</button>
              <button class="ghost" id="btnMaint">Maint</button>
            </div>
          </div>

          <div class="col-side">
            <div class="card side-card">
              <div class="small-label">Recent history</div>
              <div class="history-list" id="historyList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FLASHCARDS TAB -->
    <section class="tab-content" id="tab-flashcards">
      <div class="card">
        <div class="row-controls">
          <div>
            <label class="small-label">Flashcards source</label><br>
            <select id="fcSource">
              <option value="due">Spaced (due now)</option>
              <option value="weak">Weak topics</option>
              <option value="flagged">Flagged</option>
              <option value="chapter">By chapter</option>
            </select>
            <input id="fcChapterFilter" placeholder="Chapter exact (e.g. Ch45 Burns)" style="display:none; max-width:200px;">
          </div>
          <div>
            <label class="small-label">Mode</label><br>
            <select id="fcMode">
              <option value="q-first">Question ‚Üí Answer</option>
              <option value="a-first">Answer ‚Üí Question</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card flashcard-card">
        <div id="flashcardInner" class="flashcard-inner">
          <div class="flashcard-front" id="flashcardFront">No cards yet.</div>
          <div class="flashcard-back" id="flashcardBack" style="display:none;"></div>
        </div>
        <div class="btn-row-main flashcard-controls">
          <button id="btnFcShow">Show answer</button>
          <button id="btnFcAgain">Again</button>
          <button id="btnFcGood" class="primary">Good</button>
          <button id="btnFcNext">Next</button>
        </div>
      </div>
    </section>

    <!-- EXAM SIM TAB -->
    <section class="tab-content" id="tab-exam">
      <div class="card">
        <h2>Exam Simulation</h2>
        <div class="row-controls">
          <div>
            <label class="small-label">Question pool</label><br>
            <select id="examPool">
              <option value="all">All active</option>
              <option value="weak">Weakness focus</option>
              <option value="flagged">Flagged</option>
              <option value="chapter">By chapter</option>
            </select>
            <input id="examChapterFilter" placeholder="Chapter (optional)" style="display:none; max-width:200px;">
          </div>
          <div>
            <label class="small-label">Number of questions</label><br>
            <input id="examCount" type="number" min="5" max="200" value="30" style="width:90px;">
          </div>
          <div>
            <label class="small-label">Time limit (minutes)</label><br>
            <input id="examMinutes" type="number" min="5" max="300" value="60" style="width:90px;">
          </div>
          <div class="all-actions">
            <button id="btnStartExam" class="primary">Start exam</button>
            <span class="muted tiny">Results only at the end.</span>
          </div>
        </div>
      </div>

      <div class="card" id="examActiveCard" style="display:none;">
        <div class="exam-header">
          <div>Q <span id="examIndexLabel">0</span>/<span id="examTotalLabel">0</span></div>
          <div>Time left: <span id="examTimerLabel">--:--</span></div>
        </div>
        <div id="examQuestionPanel" class="question-panel"></div>
        <div class="btn-row-main">
          <button id="btnExamPrev">Previous</button>
          <button id="btnExamNext">Next</button>
          <button id="btnExamFinish" class="danger">Finish exam</button>
        </div>
      </div>

      <div class="card" id="examResultCard" style="display:none;">
        <h3>Exam report</h3>
        <div id="examSummary"></div>
        <div id="examDetails" class="tiny muted" style="margin-top:0.5rem;"></div>
      </div>
    </section>

    <!-- DASHBOARD TAB -->
    <section class="tab-content" id="tab-dashboard">
      <div class="card">
        <h2>Study dashboard</h2>
        <div class="dashboard-grid">
          <div class="dash-box" id="dashOverall"></div>
          <div class="dash-box" id="dashWeakChapters"></div>
          <div class="dash-box" id="dashWeekly"></div>
        </div>
      </div>
    </section>

    <!-- ALL QUESTIONS TAB -->
    <section class="tab-content" id="tab-all">
      <div class="subnav">
        <button class="subnav-btn subnav-btn-active" data-allview="bank">Question bank</button>
        <button class="subnav-btn" data-allview="builder">Build from text / PDF</button>
      </div>

      <div id="allViewBank">
      <div class="card">
        <div class="row-controls">
          <div>
            <label class="small-label">Search</label><br>
            <input id="allSearch" placeholder="Text / chapter / source / tag" style="min-width:220px;">
          </div>
          <div>
            <label class="small-label">Filter</label><br>
            <select id="allFilter">
              <option value="all">All</option>
              <option value="flagged">Flagged only</option>
              <option value="wrong">Wrong ‚â• 1</option>
              <option value="maintenance">Maintenance only</option>
              <option value="inactive">Inactive</option>
              <option value="weak">Weakness cluster</option>
              <option value="duplicate">Repeated questions</option>
              <option value="pinned">Pinned only</option>
            </select>
          </div>
          <div>
            <label class="small-label">Sort</label><br>
            <select id="allSort">
              <option value="created_desc">Newest first</option>
              <option value="created_asc">Oldest first</option>
              <option value="chapter">By chapter</option>
              <option value="wrong_desc">Most wrong</option>
              <option value="due_asc">Due soon</option>
              <option value="text_asc">Text A‚ÜíZ</option>
            </select>
          </div>
          <div>
            <label class="small-label">Range / chapter</label><br>
            <input id="rangeFrom" type="number" min="1" placeholder="From ID" style="width:90px;">
            <input id="rangeTo" type="number" min="1" placeholder="To ID" style="width:90px;">
            <select id="allChapterSelect" style="min-width:180px;">
              <option value="">All chapters</option>
            </select>
            <input id="allChapterExact" placeholder="Chapter exact (case‚Äëinsensitive)" style="min-width:160px; display:none;"><br>
            <input id="allLastN" type="number" min="0" placeholder="Last N (0 = all)" style="width:120px; margin-top:4px;">
            <label class="small-label" style="display:inline-block; margin-left:8px;">
              <input type="checkbox" id="allRangeMode"> Range select (first‚Üîlast)
            </label>
          </div>
          <div class="all-actions">
            <button id="btnAllReload">Reload</button>
            <button id="btnAllDelete" class="danger">Delete selected</button>
            <button id="btnAllDeleteDups" class="danger">Delete duplicates (keep one)</button>
          </div>
        </div>

        
        <div class="row-controls">
          <div class="side-block">
            <div class="small-label">Import / export questions</div>
            <input type="file" id="fileInput" accept=".json">
            <div class="btn-row-tight">
              <button id="btnImport">Import</button>
              <button id="btnExport">Export</button>
            </div>
            <div class="builder-inline" style="margin-top:4px;">
              <input id="fileUrlInput" placeholder="JSON URL (optional)" style="min-width:220px;">
              <button id="btnImportUrl">Import URL</button>
            </div>
            <div class="muted tiny">
              JSON file with questions, choices, correct answer, explanation, chapter, tags, images.
            </div>
          </div>
        </div>
<div class="table-wrapper all-table-wrapper">
          <table class="q-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="allSelectAll"></th>
                <th>ID</th>
                <th>Question</th>
                <th>Chapter</th>
                <th>Tags</th>
                <th>Meta</th>
                <th>Seen</th>
                <th>Wrong</th>
                <th>Due</th>
                <th>Edit</th>
              </tr>
            </thead>
            <tbody id="allTableBody"></tbody>
          </table>
        </div>
        <div class="all-footer">
          <div class="all-selected-indicator">
            Selected: <span id="allSelectedCount">0</span>
          </div>
          <div class="all-bulk-actions">
            <button id="allBulkSetChapter">Set chapter for selected</button>
            <button id="allBulkAddTag">Add tag to selected</button>
          </div>
          <div class="all-pager">
            <button id="allPrevPage">&lt; Prev</button>
            <span id="allPageInfo">Page 1 / 1</span>
            <button id="allNextPage">Next &gt;</button>
          </div>
        </div>
            </div> <!-- end allViewBank -->

      <div id="allViewBuilder" style="display:none;">
        <div class="card">
          <h2>Build questions from text / file</h2>
          <p class="muted tiny">
            Paste source text (any language). I will help you generate a ChatGPT prompt and then let you paste back the JSON questions for preview and import.
          </p>
          <div class="builder-row">
            <div class="builder-col">
              <h3>Step 1 ‚Äì Source</h3>
              <textarea id="builderSourceText" rows="8" placeholder="Paste source text here..."></textarea>
              <div class="builder-inline">
                <label># MCQs to generate:</label>
                <input id="builderNumQuestions" type="number" min="1" max="200" value="20" style="width:80px;">
              </div>
              <button id="btnBuilderMakePrompt">Generate prompt for ChatGPT</button>
              <textarea id="builderPromptOut" rows="10" readonly placeholder="Prompt for ChatGPT will appear here..."></textarea>
            </div>
            <div class="builder-col">
              <h3>Step 2 ‚Äì JSON from ChatGPT</h3>
              <p class="muted tiny">
                After ChatGPT generates the JSON array of questions, paste it below and click Preview.
              </p>
              <textarea id="builderJsonInput" rows="12" placeholder='[ { "id": 1, "text": "...", ... }, ... ]'></textarea>
              <div class="builder-inline">
                <button id="btnBuilderPreview">Preview questions</button>
                <button id="btnBuilderImportSelected">Import selected into bank</button>
              </div>
              <div id="builderPreview" class="builder-preview muted tiny">
                No preview yet.
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- BACKUP & CLOUD TAB -->
    <section class="tab-content" id="tab-backup">
      <div class="card">
        <h2>Local backup</h2>
        <p class="muted tiny">
          Export creates a JSON file with all questions + stats. Import can merge or restore from that file.
        </p>
        <div class="row-controls">
          <div>
            <button id="btnBackupExport" class="primary">Export full backup</button>
            <input type="file" id="backupFileInput" accept=".json">
            <button id="btnBackupImport">Import backup</button>
          </div>
          <div class="backup-status">
            <div>Last activity: <span id="lastActivityLabel">‚Äì</span></div>
            <div>Last local backup: <span id="lastBackupLabel">‚Äì</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Cloud sync (GitHub)</h2>
        <p class="muted tiny">
          Uses your GitHub token to save / load one JSON file in a private repo (e.g. <code>Awad1992/mcq-data</code>).
          Token stays only on this device (localStorage).
        </p>
        <div class="row-controls">
          <div>
            <button id="btnCloudUpload">Upload ‚Üí GitHub</button>
            <button id="btnCloudDownload">Download ‚Üê GitHub</button>
          </div>
          <div class="muted tiny" id="cloudInfo"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section class="tab-content" id="tab-settings">
      <div class="card">
        <h2>GitHub settings</h2>
        <div class="settings-grid">
          <label>
            <span class="small-label">Personal access token</span>
            <input type="password" id="ghTokenInput" placeholder="ghp_xxx..." autocomplete="off">
          </label>
          <label>
            <span class="small-label">Repo (owner/name)</span>
            <input id="ghRepoInput" value="Awad1992/mcq-data">
          </label>
          <label>
            <span class="small-label">Backup filename</span>
            <input id="ghFileInput" value="mcq_backup.json">
          </label>
        </div>
        <div class="btn-row-main">
          <button id="btnSaveGitHub" class="primary">Save settings</button>
          <button id="btnClearGitHub" class="ghost">Clear</button>
          <a class="link-btn" href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer">
            Open GitHub token page
          </a>
        </div>
        <p class="muted tiny">
          Token is stored only in this browser (localStorage). Changing token or repo does not affect your questions.
        </p>
      </div>

      <div class="card">
        <h2>Progress & reset</h2>
        <p class="muted tiny">
          Reset only affects your local progress (times seen, wrong count, due dates, answers). Questions themselves stay saved.
        </p>
        <div class="settings-grid">
          <label>
            <span class="small-label">Reset scope</span>
            <select id="resetScope">
              <option value="all">All questions</option>
              <option value="wrong">Only questions ever answered wrong</option>
            </select>
          </label>
        </div>
        <div class="btn-row-main">
          <button id="btnResetProgress" class="danger">Reset selected progress‚Ä¶</button>
        </div>
      </div>

      <div class="card">
        <h2>App info</h2>
        <p class="muted tiny">
          Version: <strong>4.3.1</strong><br>
          Storage: IndexedDB (local), plus optional GitHub JSON sync.<br>
          Engine: spaced repetition + weakness clustering + tags + flashcards.
        </p>
      </div>
    </section>

  </main>
</div>

<!-- Edit / add question modal -->
<div id="editModal" class="modal hidden">
  <div class="modal-backdrop" id="editModalBackdrop"></div>
  <div class="modal-body">
    <h3 id="editModalTitle">Edit question</h3>
    <div class="modal-content">
      <label class="small-label">Question text</label>
      <textarea id="editText" rows="3"></textarea>

      <label class="small-label">Chapter</label>
      <input id="editChapter">

      <label class="small-label">Source</label>
      <input id="editSource">

      <label class="small-label">Tags (comma‚Äëseparated)</label>
      <input id="editTags">

      <label class="small-label">Explanation</label>
      <textarea id="editExplanation" rows="3"></textarea>

      <label class="small-label">Image (URL)</label>
      <input id="editImageUrl" placeholder="https://...">

      <label class="small-label">Or attach image (stored locally)</label>
      <input id="editImageFile" type="file" accept="image/*">

      <div id="editImagePreview" class="img-preview"></div>

      <div class="small-label" style="margin-top:0.5rem;">Choices</div>
      <div id="editChoices"></div>
      <button id="btnAddChoice" class="pill-btn">+ Choice</button>

      <div class="modal-flags">
        <label><input type="checkbox" id="editFlagged"> Flagged</label>
        <label><input type="checkbox" id="editMaint"> Maintenance</label>
        <label><input type="checkbox" id="editPinned"> Pinned</label>
        <label><input type="checkbox" id="editActive"> Active</label>
      </div>
    </div>
    <div class="btn-row-main modal-actions">
      <button id="btnEditSave" class="primary">Save</button>
      <button id="btnEditCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
  window.APP_VERSION = "4.3.1";
</script>
<script type="module" src="app.js?v=4.3.1"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js?v=4.3.1').catch(()=>{});
  }
</script>
</body>
</html>
